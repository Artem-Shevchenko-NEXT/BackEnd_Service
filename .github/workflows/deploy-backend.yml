# GitHub Actions Workflow - Backend Deployment
name: Deploy Backend to Production

on:
  push:
    branches:
      - master
    paths:
      - 'src/**'
      - 'pom.xml'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch: 

jobs:
  deploy:
    name: Build and Deploy Spring Boot Backend
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Check out the repository code
      - name: Checkout code
        uses: actions/checkout@v4
        
      # Step 2: Set up Java 21
      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'
          
      # Step 3: Build with Maven
      - name: Build with Maven
        run: mvn clean package -DskipTests
        
      # Step 4: Verify JAR was created
      - name: Verify JAR file
        run: |
          if [ ! -f target/*.jar ]; then
            echo "JAR file not found!"
            exit 1
          fi
          echo "JAR file created successfully:"
          ls -lh target/*.jar
          
      # Step 5: Install SSH key
      - name: Install SSH key
        run: |
          install -m 600 -D /dev/null ~/.ssh/id_rsa
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
          
      # Step 6: Upload JAR to server
      - name: Upload JAR to server
        run: |
          scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            target/*.jar \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/opt/doors-backend/app.jar
          
      # Step 7: Restart backend service
      - name: Restart backend service
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "sudo systemctl restart doors-backend.service"
          
      # Step 8: Wait for the service to start
      - name: Wait for service startup
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "sleep 10"
          
      # Step 9: Verify deployment
      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "sudo systemctl status doors-backend.service --no-pager"
          
      # Step 10: Test API endpoint
      - name: Test API endpoint
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.SERVER_HOST }}:8080/clients)
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "API is responding correctly (HTTP $HTTP_CODE)"
          else
            echo "API returned unexpected status (HTTP $HTTP_CODE)"
            exit 1
          fi
          
      # Step 11: Deployment summary
      - name: Deployment summary
        if: success()
        run: |
          echo "Backend deployment completed successfully!"
          echo "JAR deployed to: /opt/doors-backend/app.jar"
          echo "Service restarted: doors-backend.service"
          echo "API available at: http://${{ secrets.SERVER_HOST }}:8080/clients"
